name: Build OSRM Backend

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch: # 允许手动触发

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    # 1. 获取代码
    - name: Checkout repository
      uses: actions/checkout@v4

    # 2. 配置ccache缓存
    - name: Setup ccache
      uses: actions/cache@v4
      with:
        path: ~/.ccache
        key: ${{ runner.os }}-ccache-osrm-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-ccache-osrm-

    # 3. 安装依赖 (关键：安装并切换至 GCC 12)
    - name: Install dependencies
      run: |
        sudo apt-get update
        # 安装 GCC 12 并设置为默认编译器
        sudo apt-get install -y gcc-12 g++-12
        sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-12 100
        sudo update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-12 100
        # 安装项目所需的其他库
        sudo apt-get install -y \
          build-essential git cmake pkg-config \
          libbz2-dev libxml2-dev libzip-dev libboost-all-dev \
          lua5.2 liblua5.2-dev libtbb-dev \
          ccache

    - name: Show compiler version
      run: |
        gcc --version
        g++ --version
        ccache --version || true

    # 4. 配置与编译 (核心修改：使用 C++20 与显式编译器)
    - name: Configure and Build
      env:
        CC: gcc-12
        CXX: g++-12
        CCACHE_DIR: ~/.ccache
      run: |
        mkdir -p build
        cd build
        cmake .. \
          -DCMAKE_C_COMPILER=gcc-12 \
          -DCMAKE_CXX_COMPILER=g++-12 \
          -DCMAKE_CXX_STANDARD=20 \
          -DCMAKE_CXX_STANDARD_REQUIRED=ON \
          -DCMAKE_CXX_COMPILER_LAUNCHER=ccache
        cmake --build . -j$(nproc)

    # 5. 运行测试 (可选)
    - name: Run Tests
      run: |
        cd build
        ctest --output-on-failure || true

    # 6. 上传编译产物
    - name: Upload Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: osrm-binaries
        path: |
          build/*.so
          build/osrm-*
        retention-days: 7
